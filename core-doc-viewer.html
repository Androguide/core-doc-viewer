<link rel="import" href="../core-layout/core-layout.html">
<link rel="import" href="../core-layout-grid/core-layout-grid.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-item/core-item.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">

<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../highlightjs-element/highlightjs-element.html">

<link rel="import" href="context-free-parser.html">

<!--

Displays formatted source documentation scraped from input urls.

@group Polymer Core Elements
@element core-doc-viewer

-->

<polymer-element name="core-doc-viewer" attributes="url href sources">
<template>

  <context-free-parser url="{{url}}" on-data-ready="{{parserDataReady}}"></context-free-parser>

  <template repeat="{{sources}}">
    <context-free-parser url="{{}}" on-data-ready="{{parserDataReady}}"></context-free-parser>
  </template>

  <link rel="stylesheet" href="../highlightjs/styles/default.css">
  <link rel="stylesheet" href="core-doc-viewer.css">

  <core-layout-grid id="grid" on-core-layout="{{gridLayout}}"></core-layout-grid>

  <div id="navigation" offscreen="basement" style="overflow-y: scroll;">

    <core-menu selected="0" id="menu">

      <template repeat="{{classes}}">
        <core-item><a href="#{{name}}">{{name}}</a></core-item>
      </template>

    </core-menu>

  </div>

  <div id="docs" flex on-marked-js-highlight="{{hilight}}" on-scroll="{{docsScroll}}">
    <div id="docsInner" flex>

      <div id="fixed">
        <div class="header">

          <core-icon-button icon="menu" on-tap="{{toggleNav}}" active="{{navOpen}}"></core-icon-button>
          &nbsp;<span id="fixedTopic" class="element"></span>

        </div>
      </div>

      <template repeat="{{class in classes}}">

        <a id="{{class.name}}" class="element"></a>

        <div class="header topic">
          <core-icon-button on-tap="{{toggleLayout}}" icon="menu" style="visibility: hidden;"></core-icon-button>
          &nbsp;<span class="element">{{class.name}}</span>
        </div>
  
        <div>
          <core-layout></core-layout>

          <div class="summary">

            <template if="{{class.methods.length}}">
              <section class="box">
                <div class="ntitle">Methods</div>
                <template repeat="{{class.methods}}">
                  <span class="name method">{{name}}</span><br>
                </template>
              </section>
            </template>

            <template if="{{class.attributes.length}}">
              <section class="box">
                <div class="ntitle">Attributes</div>
                <template repeat="{{class.attributes}}">
                  <span class="name nattribute">{{name}}</span><br>
                </template>
              </section>
            </template>

            <template if="{{class.events.length}}">
              <section class="box">
                <div class="ntitle">Events</div>
                <template repeat="{{class.events}}">
                  <span class="name event">{{name}}</span><br>
                </template>
              </section>
            </template>

          </div>

          <div flex>
            <div style="padding: 16px;">

              <template if="{{class.description}}">
                <section class="box">
                  <div class="ntitle">Description</div>
                  <marked-element text="{{class.description}}"></marked-element>
                </section>
              </template>

              <template if="{{class.methods.length}}">
                <section class="box">
                  <div class="ntitle">Methods</div>
                  <template repeat="{{class.methods}}">
                    <span class="name method">{{name}}</span>
                    <marked-element text="{{description}}"></marked-element>
                  </template>
                </section>
              </template>

              <template if="{{class.attributes.length}}">
                <section class="box">
                  <div class="ntitle">Attributes</div>
                  <template repeat="{{class.attributes}}">
                    <span class="name nattribute">{{name}}</span><span class="name type">{{type}}</span>
                    <marked-element text="{{description}}"></marked-element>
                  </template>
                </section>
              </template>

              <template if="{{class.events.length}}">
                <section class="box">
                  <div class="ntitle">Events</div>
                  <template repeat="{{class.events}}">
                    <span class="name event">{{name}}</span>
                    <marked-element text="{{description}}"></marked-element>
                  </template>
                </section>
              </template>

            </div>
          </div>
        </div>
      </template>

      <hr>
      <div style="height: 1024px"></div>

    </div>
  </div>

</template>
<script>

  Polymer('core-doc-viewer', {
    /**
      *
      * Set url to add documentation from that location to the view.
      *
      * @attribute url
      * @type String
      */

    sources: [],
    data: null,
    route: '',
    layouts: {
      open: [
        [1, 2, 2]
      ],
      closed: [
        [2, 2]
      ],
    },
    navOpen: true,

    ready: function() {
      this.classes = [];
      // TODO(sjmiles): manual because flatiron-director didn't work, find out why
      window.addEventListener('hashchange', this.parseLocationHash.bind(this));
      this.parseLocationHash();
      // TODO(sjmiles): improve method of configuring grid
      this.$.grid.nodes = [this.$.navigation, this.$.docs];
      this.$.grid.layout = this.layouts.open;
      this.onMutation(this.$.docs, this.docsNodeChanged);
    },

    parseLocationHash: function() {
      this.route = window.location.hash.slice(1);
    },

    routeChanged: function() {
      var anchor = this.shadowRoot.querySelector('a[id="' + this.route + '"]');
      if (anchor) {
        anchor.scrollIntoView();
      }
    },

    toggleNav: function(event, detail, sender) {
      this.navOpen = !this.navOpen;
    },

    navOpenChanged: function() {
      this.effectLayout();
    },

    effectLayout: function() {
      this.$.grid.layout = this.navOpen ? this.layouts.open : this.layouts.closed;
      this.$.fixed.style.left = this.navOpen ? this.fixedLeft + 'px' : '0px';
    },

    gridLayout: function() {
      // TODO(sjmiles): the 'fixed' header bar is relative to the screen
      // to position it dynamically we need to know offsetLeft of the
      // docs panel after the first layout.
      if (!this.fixedLeft) {
        this.fixedLeft = this.$.docs.offsetLeft;
        this.$.fixed.style.display = 'block';
        this.effectLayout();
      }
      this.$.docs.classList.add('animate');
      this.$.fixed.classList.add('animate');
    },

    hilight: function(event, detail, sender) {
      detail.code = hljs.highlightAuto(detail.code).value;
    },

    docsNodeChanged: function(observer) {
      this.$.docs.scrollTop = 0;
      this.docsScroll();
      this.onMutation(this.$.docs, this.docsNodeChanged);
    },

    docsScroll: function() {
      var t = this.$.docs.scrollTop + 80;
      var hcs = this.$.docsInner.querySelectorAll('.topic');
      for (var i = 0, hc; hc = hcs[i]; i++) {
        if (t >= hc.offsetTop && (!hcs[i+1] || t < hcs[i+1].offsetTop)) {
          var h = hc.querySelector('.element');
          if (h) {
            this.$.fixedTopic.innerText = h.innerText;
          }
          return;
        }
      }
    },

    parserDataReady: function(event) {
      this.assimilateData(event.target.data);
    },

    dataChanged: function() {
      this.assimilateData(this.data);
    },

    assimilateData: function(data) {
      this.classes = this.classes.concat(data.classes);
      this.classes.sort(function(a, b) {
        var na = a.name.toLowerCase(), nb = b.name.toLowerCase();
        return (na < nb) ? -1 : (na == nb) ? 0 : 1;
      });
    }

  });

</script>
</polymer-element>
